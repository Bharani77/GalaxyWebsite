(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{4233:function(e,r,s){Promise.resolve().then(s.bind(s,5925)),Promise.resolve().then(s.t.bind(s,2489,23)),Promise.resolve().then(s.t.bind(s,2998,23)),Promise.resolve().then(s.bind(s,3945))},3945:function(e,r,s){"use strict";s.r(r),s.d(r,{SessionProvider:function(){return g},useSession:function(){return u}});var o=s(7437),n=s(2265),t=s(4033),i=s(5611),a=s(5925),c=s(4566);let l=(0,c.eI)("https://scxxvniczlyzyumuiohc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeHh2bmljemx5enl1bXVpb2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIzNTAzMDMsImV4cCI6MjA0NzkyNjMwM30.AM5S6xAISMEH41V7pLsJSznd-b2hiene5ZGOClgZh-4"),d=(0,n.createContext)({isLoading:!0,isAuthenticated:!1,isAdmin:!1,username:null,token:null}),u=()=>(0,n.useContext)(d);function g(e){let{children:r}=e,[s,c]=(0,n.useState)(!0),[u,g]=(0,n.useState)(!1),[f,m]=(0,n.useState)(!1),[p,h]=(0,n.useState)(null),[I,w]=(0,n.useState)(null),v=(0,t.useRouter)(),_=(0,t.usePathname)(),y=async e=>{console.log("Real-time change detected:",e);let r=JSON.parse(localStorage.getItem("session")||"{}");if(r&&r.username){if("DELETE"===e.eventType&&e.old_record&&e.old_record.username===r.username){console.log("User deleted, showing notification"),localStorage.removeItem("session"),g(!1),m(!1),h(null),w(null),a.toast.remove(),a.toast.error("Your access has been revoked by admin",{duration:5e3,position:"top-center",style:{background:"#ff4b4b",color:"#fff",fontSize:"16px",padding:"16px",maxWidth:"500px",textAlign:"center"}}),v.replace("/");return}if("UPDATE"===e.eventType&&e.old_record.username===r.username&&(!e.new_record.token||e.new_record.token!==e.old_record.token)){console.log("Token modified, showing notification"),localStorage.removeItem("session"),g(!1),m(!1),h(null),w(null),a.toast.remove(),a.toast.error("Your access token has been modified by admin",{duration:5e3,position:"top-center",style:{background:"#ff4b4b",color:"#fff",fontSize:"16px",padding:"16px",maxWidth:"500px",textAlign:"center"}}),v.replace("/");return}e.new_record&&e.new_record.username===r.username&&b()}},S=async e=>{var r;let s=JSON.parse(localStorage.getItem("session")||"{}");s&&s.sessionId&&(console.log("Session change detected:",{eventType:e.eventType,currentSessionId:s.sessionId,payloadSessionId:null===(r=e.new_record)||void 0===r?void 0:r.session_id,userId:s.userId}),("INSERT"===e.eventType||"UPDATE"===e.eventType)&&e.new_record.user_id===s.userId&&e.new_record.session_id!==s.sessionId&&(console.log("Another session detected, checking if it is newer"),e.new_record.is_active&&new Date(e.new_record.created_at)>new Date(s.created_at)&&(console.log("Newer active session found, invalidating current session"),localStorage.removeItem("session"),g(!1),m(!1),h(null),w(null),a.toast.error("Your session has ended because you signed in from another browser",{duration:5e3,position:"top-center",style:{background:"#ff4b4b",color:"#fff",fontSize:"16px",padding:"16px",maxWidth:"500px",textAlign:"center"}}),v.replace("/signin"))),"UPDATE"!==e.eventType||e.old_record.session_id!==s.sessionId||e.new_record.is_active||(console.log("Current session was deactivated"),localStorage.removeItem("session"),g(!1),m(!1),h(null),w(null),a.toast.error("Your session was deactivated",{duration:5e3,position:"top-center",style:{background:"#ff4b4b",color:"#fff",fontSize:"16px",padding:"16px",maxWidth:"500px",textAlign:"center"}}),v.replace("/signin")))},b=async()=>{try{console.log("Starting session validation");let e=await (0,i.bV)();e?(console.log("Session validated successfully:",{...e,token:"[REDACTED]"}),g(!0),m(e.isAdmin),h(e.username),w(e.token||null),e.isAdmin?"/"===_&&v.push("/admin"):_.startsWith("/admin")&&v.replace("/")):(console.log("No valid session found"),g(!1),m(!1),h(null),w(null),"/signin"!==_&&"/signup"!==_&&v.replace("/signin"))}catch(e){console.error("Session validation error:",e),g(!1),m(!1),h(null),w(null),a.toast.error(e.message||"Session validation failed",{duration:5e3,position:"top-center"}),"/signin"!==_&&"/signup"!==_&&v.replace("/signin")}finally{c(!1)}};return(0,n.useEffect)(()=>{let e=JSON.parse(localStorage.getItem("session")||"{}");if(!e||!e.userId)return;console.log("Setting up real-time subscriptions for user:",e.userId);let r=l.channel("db-changes").on("postgres_changes",{event:"*",schema:"public",table:"users",filter:"username=eq.".concat(e.username)},y).on("postgres_changes",{event:"*",schema:"public",table:"sessions",filter:"user_id=eq.".concat(e.userId)},S).subscribe(e=>{console.log("Subscription status:",e)});return b(),()=>{console.log("Cleaning up subscriptions"),r.unsubscribe()}},[_]),(0,n.useEffect)(()=>{let e,r=!0,s=async()=>{if(r){try{await b()}catch(e){console.error("Validation error:",e),"/signin"!==_&&(a.toast.error(e.message,{duration:5e3,position:"top-center"}),v.replace("/"))}e=setTimeout(s,3e3)}};return s(),()=>{r=!1,clearTimeout(e)}},[_]),(0,o.jsx)(d.Provider,{value:{isLoading:s,isAuthenticated:u,isAdmin:f,username:p,token:I},children:r})}},5611:function(e,r,s){"use strict";s.d(r,{bV:function(){return w},Gg:function(){return h},zB:function(){return g},w7:function(){return m},y1:function(){return f}});var o=s(4566),n=s(225),t=s(517);let i=null,a=async()=>{if(i)return i;try{let e=await t.ZP.load(),r=await e.get();return i=r.visitorId}catch(e){throw console.error("Error generating fingerprint:",e),Error("Failed to generate device fingerprint")}},c=(0,o.eI)("https://scxxvniczlyzyumuiohc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeHh2bmljemx5enl1bXVpb2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIzNTAzMDMsImV4cCI6MjA0NzkyNjMwM30.AM5S6xAISMEH41V7pLsJSznd-b2hiene5ZGOClgZh-4"),l=(0,o.eI)("https://scxxvniczlyzyumuiohc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeHh2bmljemx5enl1bXVpb2hjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczMjM1MDMwMywiZXhwIjoyMDQ3OTI2MzAzfQ.50LNYYbfszw6IzHma3S6SIL53ZGFfVpj0Ty1x3ycj0o",{auth:{autoRefreshToken:!1,persistSession:!1}});async function d(e,r){try{console.log("Creating new session for user:",e);let s=(0,n.Z)(),{error:o}=await l.from("sessions").update({is_active:!1}).eq("user_id",e);if(o)throw console.error("Error deactivating existing sessions:",o),Error("Failed to deactivate existing sessions");await new Promise(e=>setTimeout(e,500));let{error:t}=await l.from("sessions").insert([{user_id:e,session_id:s,device_fingerprint:r,is_active:!0,created_at:new Date().toISOString(),last_active:new Date().toISOString()}]);if(t)throw console.error("Error creating session:",t),Error("Failed to create session");let{data:i,error:a}=await l.from("sessions").select("*").eq("user_id",e).eq("is_active",!0);if(a)throw console.error("Error checking active sessions:",a),Error("Failed to verify session creation");if(!i||0===i.length)throw Error("Failed to create session - no active sessions found");if(i.length>1){let r=i.reduce((e,r)=>new Date(r.created_at)>new Date(e.created_at)?r:e);if(await l.from("sessions").update({is_active:!1}).eq("user_id",e).neq("id",r.id),r.session_id!==s)throw Error("Another session was created simultaneously")}return console.log("Successfully created session with ID:",s),s}catch(e){throw console.error("Session creation error:",e),e}}async function u(e,r){try{console.log("Validating session:",{sessionId:e,userId:r});let s=await a(),{data:o,error:n}=await l.from("sessions").select("*").eq("session_id",e).eq("user_id",r).eq("is_active",!0).single();if(n)return console.error("Session validation error:",n),!1;if(!o)return console.log("No active session found"),!1;if(o.device_fingerprint!==s)return console.log("Device fingerprint mismatch"),await l.from("sessions").update({is_active:!1}).eq("session_id",e),!1;console.log("Found active session:",o);let{error:t}=await l.from("sessions").update({last_active:new Date().toISOString()}).eq("session_id",e);return t&&console.error("Error updating last_active:",t),!0}catch(e){return console.error("Unexpected error in validateSession:",e),!1}}async function g(e,r){try{let s;console.log("Starting sign in process for username:",e);let o=await a();if(console.log("Device fingerprint:",o),"Bharani"===e){if("HackerBharani"===r){let r=(0,n.Z)(),s={username:e,isLoggedIn:!0,isAdmin:!0,deviceFingerprint:o,sessionId:r,userId:"admin"};return p(s),s}throw Error("Invalid username or password")}let{data:t,error:i}=await c.from("users").select("*").eq("username",e).single();if(i||!t)throw console.error("User lookup error:",i),Error("Invalid username or password");let{data:u,error:g}=await l.from("sessions").select("*").eq("user_id",t.id).eq("is_active",!0);if(g)console.error("Error checking existing sessions:",g);else if(u&&u.length>0){let e=u[0];if(e.device_fingerprint!==o)throw Error("You are already logged in from another browser. Please sign out there first.")}try{s=await d(t.id,o),console.log("Created new session:",s)}catch(e){throw console.error("Failed to create session:",e),Error("Failed to create session. Please try again.")}let f={username:t.username,userId:t.id,isLoggedIn:!0,sessionId:s,token:t.token,deviceFingerprint:o,tokenExpiry:t.token_expiry};return p(f),f}catch(e){throw console.error("Sign in error:",e),e}}async function f(e,r,s){try{console.log("Starting sign up process for username:",e);let o=await a();console.log("Generated device fingerprint:",o);let{data:n,error:t}=await c.from("users").select("username").eq("username",e).single();if(t&&console.error("Error checking existing user:",t),n)throw Error("Username already exists");let{data:i,error:l}=await c.from("tokens").select("*").eq("token",s).single();if(l)throw console.error("Token verification error:",l),Error("Invalid token");if(!i)throw Error("Invalid token");if(i.is_used)throw Error("Token has already been used");let d={username:e,password:r,token:s,device_fingerprint:o,created_at:new Date().toISOString(),token_expiry:i.expiry_date};console.log("Attempting to create user with data:",{...d,password:"[REDACTED]",token:"[REDACTED]"});let{data:u,error:g}=await c.from("users").insert([d]).select().single();if(g)throw console.error("Detailed error creating user:",{message:g.message,details:g.details,hint:g.hint,code:g.code}),Error("Failed to create user account: ".concat(g.message));let{error:f}=await c.from("tokens").update({is_used:!0,used_by:e}).eq("token",s);return f&&console.error("Error updating token status:",f),console.log("Successfully created user:",{...u,password:"[REDACTED]",token:"[REDACTED]"}),{user:u,error:null}}catch(e){throw console.error("Sign up error:",e),e}}async function m(){try{let e=h();if((null==e?void 0:e.sessionId)&&(null==e?void 0:e.userId)){let{error:r}=await l.from("sessions").update({is_active:!1}).eq("session_id",e.sessionId).eq("user_id",e.userId);r&&console.error("Error ending session:",r)}}catch(e){console.error("Error during sign out:",e)}finally{I()}}function p(e){try{localStorage.setItem("session",JSON.stringify(e))}catch(e){console.error("Error saving session:",e)}}function h(){try{let e=localStorage.getItem("session");if(!e)return null;return JSON.parse(e)}catch(e){return console.error("Error reading session:",e),null}}function I(){localStorage.removeItem("session")}async function w(){let e=h();if(!e||!e.isLoggedIn)return null;if(e.isAdmin)return"Bharani"===e.username?e:(I(),null);try{console.log("Checking session for user:",e.username);let{data:r,error:s}=await c.from("users").select("*").eq("username",e.username).single();if(s){if(console.error("User lookup error:",s),"PGRST116"!==s.code)return e;throw I(),Error("Failed to verify user access")}if(!r)throw I(),Error("User not found or access revoked");let{data:o,error:n}=await c.from("tokens").select("*").eq("token",r.token).single();if(n&&(console.error("Token lookup error:",n),"PGRST116"!==n.code))return e;if(!o)throw I(),Error("Invalid token. Please contact admin.");let t=new Date(o.expiry_date);if(t<new Date)throw I(),Error("Your access token has expired. Please contact admin for renewal.");if(!o.is_used)throw I(),Error("Your token has been deactivated. Please contact admin to reactivate.");if(e.sessionId&&e.userId){let r=await u(e.sessionId,e.userId);if(!r)return console.warn("Session validation failed, but keeping session active"),e}let i={...e,username:r.username,userId:r.id,isLoggedIn:!0,isAdmin:!1,token:r.token,deviceFingerprint:e.deviceFingerprint};return p(i),i}catch(e){throw console.error("Session check error:",e),(e.message.includes("revoked")||e.message.includes("expired")||e.message.includes("deactivated"))&&I(),e}}},2489:function(){},2998:function(e){e.exports={style:{fontFamily:"'__Inter_d65c78', '__Inter_Fallback_d65c78'",fontStyle:"normal"},className:"__className_d65c78"}},4033:function(e,r,s){e.exports=s(94)}},function(e){e.O(0,[638,971,472,744],function(){return e(e.s=4233)}),_N_E=e.O()}]);